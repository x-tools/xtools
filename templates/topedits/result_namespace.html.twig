{% extends is_sub_request ? 'subrequest.html.twig' : 'base.html.twig' %}
{% import 'macros/layout.html.twig' as layout %}
{% import 'macros/wiki.html.twig' as wiki %}

{% block body %}

{% if not is_sub_request %}
    <div class="panel panel-primary">
        {{ layout.userHeading(user, project, 'TopEdits') }}
        <div class="panel-body xt-panel-body">
            {{ wiki.userLinks(user, project, 'TopEdits') }}
            <h3 class="text-center">{{ msg('topedits-per-namespace') }}</h3>

            {% if project.userHasOptedIn(user) and te.topEdits|length > 2 %}
                {{ layout.nsToc(project, te.topEdits|keys) }}
            {% endif %}

            {% set content %}
                <div class="col-lg-6 stat-list clearfix">
                    <table class="table"><tbody>
                        <tr>
                            <td>{{ msg('namespace') }}</td>
                            <td>
                                {{ nsName(te.namespace, project.namespaces) }}
                            </td>
                        </tr>
                        {% if te.start is not empty %}
                            <tr>
                                <td>{{ msg('start') }}</td>
                                <td>{{ te.startDate }}</td>
                            </tr>
                        {% endif %}
                        {% if te.end is not empty %}
                            <tr>
                                <td>{{ msg('end') }}</td>
                                <td>{{ te.endDate }}</td>
                            </tr>
                        {% endif %}
                        <tr>
                            <td class="stat-list--new-group">{{ msg('total-edits') }}</td>
                            <td class="stat-list--new-group">{{ te.numTopEdits|num_format }}</td>
                        </tr>
                        <tr>
                            <td>{{ msg('unique-pages-edited') }}</td>
                            <td>{{ te.getNumPagesNamespace|num_format }}</td>
                        </tr>
                    </tbody></table>
                </div>
            {% endset %}
            {{ layout.content_block('summary', content) }}
{% endif %}

{% if not(project.userHasOptedIn(user)) %}
    {{ wiki.userOptedOut(project, user) }}
{% elseif te.topEdits|length > 0 %}
    {% for ns, pages in te.topEdits %}
        {% set showPageAssessment = project.hasPageAssessments(ns) %}
        {% set content %}
        <div class="side-to-side xt-show-hide--target">
            <div><table class="table table-bordered table-hover table-striped topedits-namespace-table">
                <thead><tr>
                    <th>
                        <span class="sort-link sort-link--edits" data-column="edits">
                            {{ msg('edits')|ucfirst }}
                            <span class="glyphicon glyphicon-sort"></span>
                        </span>
                    </th>
                    <th>
                        <span class="sort-link sort-link--page" data-column="page">
                            {{ msg('page-title') }}
                            <span class="glyphicon glyphicon-sort"></span>
                        </span>
                    </th>
                    {% if showPageAssessment %}
                        <th>
                            <span class="sort-link sort-link--assessment" data-column="assessment">
                                {{ msg('assessment') }}
                                <span class="glyphicon glyphicon-sort"></span>
                            </span>
                        </th>
                    {% endif %}
                    <th>{{ msg('links') }}</th>
                </tr></thead>
                <tbody>
                    {% for page in pages %}
                        {% set pageTitle = titleWithNs(page.page_title, page.namespace, project.namespaces) %}
                        <tr>
                            <td class="sort-entry--edits" data-value="{{ page.count }}">
                                {{ page.count|num_format }}
                            </td>
                            <td class="sort-entry--page display-title" data-value="{{ pageTitle }}">
                                {{ wiki.pageLinkRaw(pageTitle, project) }}
                            </td>
                            {% if showPageAssessment %}
                                <td class="sort-entry--assessment" data-value="{{ page.assessment.class }}">
                                    {% set badge = project.pageAssessments.badgeURL(page.assessment.class) %}
                                    {% if badge is defined %}
                                        <img alt="{{ page.assessment.class }}" src="{{ badge }}" class="assessment-badge" />
                                    {% endif %}
                                    {{ page.assessment.class ? page.assessment.class : msg('unknown') }}
                                </td>
                            {% endif %}
                            <td>
                                {{ wiki.pageLogLinkRaw(pageTitle, project) }}
                                &middot;
                                <a href="{{ path('PageInfoResult', {project:project.domain, page:pageTitle}) }}">{{ msg('tool-pageinfo') }}</a>
                                &middot;
                                <a href="{{ path('TopEditsResultPage', {project:project.domain, username:user.usernameIdent, namespace:page.namespace, page:page.page_title}) }}" >{{ msg('tool-topedits') }}</a>
                            </td>
                        </tr>
                    {% endfor %}
                    {% if pages|length >= 10 and te.topEdits|length > 1 %}
                        <tr>
                            <td colspan={{ showPageAssessment ? 4 : 3 }}>
                                <a href="{{ path('TopEditsResultNamespace', {project:project.domain, username:user.usernameIdent, namespace:ns, start:te.startDate, end:te.endDate}) }}">
                                    {{ msg('more') }}&hellip;
                                </a>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table></div>
            {% if showPageAssessment and not(is_sub_request) and te.namespace is not same as('all') %}
                {% set totals = te.projectTotals(ns) %}
                {% if totals|length > 0 %}
                    <div><table class="table table-bordered table-hover table-striped">
                        <caption class="text-center">{{ msg('top-wikiprojects') }}</caption>
                        <thead><tr>
                            <th>
                                <span class="sort-link sort-link--wikiproject" data-column="wikiproject">
                                    {{ msg('wikiproject') }}
                                    <span class="glyphicon glyphicon-sort"></span>
                                </span>
                            </th>
                            <th>
                                <span class="sort-link sort-link--count" data-column="count">
                                    {{ msg('count') }}
                                    <span class="glyphicon glyphicon-sort"></span>
                                </span>
                            </th>
                        </tr></thead>
                        <tbody>
                            {% for row in totals %}
                                <tr>
                                    <td class="sort-entry--wikiproject" data-value="{{ row.pap_project_title }}">
                                        {{ row.pap_project_title }}
                                    </td>
                                    <td class="sort-entry--count" data-value="{{ row.count }}">
                                        {{ row.count|num_format }}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table></div>
                {% endif %}
            {% endif %}
        </div>

        {% if not(is_sub_request) and te.namespace is not same as('all') %}
            {% set numPages = (te.getNumPagesNamespace / te.limit)|round(0, 'ceil') %}
            {% set hasPrev = te.pagination - 1 >= 0 %}
            {% set hasNext = te.pagination + 1 < numPages %}
            {% set pathVars = {'project': project.domain, 'username': user.usernameIdent, 'namespace': te.namespace, 'start': te.startDate, 'end': te.endDate} %}

            {% if hasNext or hasPrev %}
                <nav aria-label="...">
                    <ul class="pagination xt-pagination">
                        <li{% if not(hasPrev) %} class="disabled"{% endif %}>
                            {% if hasPrev %}
                            <a href="{{ path('TopEditsResultNamespace', pathVars|merge({'pagination': te.pagination - 1})) }}" aria-label="Previous">
                                {% endif %}
                                <span aria-hidden="true">&laquo;</span>
                                {% if hasPrev %}</a>{% endif %}
                        </li>
                        {% for page in 1..numPages %}
                            {% set active = te.pagination == loop.index0 %}
                            <li{% if active %} class="active"{% endif %}>
                                <a href="{{ path('TopEditsResultNamespace', pathVars|merge({'pagination': loop.index0})) }}">
                                    {{ page }} {% if active %}<span class="sr-only">(current)</span>{% endif %}
                                </a>
                            </li>
                        {% endfor %}
                        <li{% if not(hasNext) %} class="disabled"{% endif %}>
                            {% if hasNext %}
                            <a href="{{ path('TopEditsResultNamespace', pathVars|merge({'pagination': te.pagination + 1})) }}" aria-label="Next">
                                {% endif %}
                                <span aria-hidden="true">&raquo;</span>
                                {% if hasNext %}</a>{% endif %}
                        </li>
                    </ul>
                </nav>
            {% endif %}
        {% endif %}
        {% endset %}

        {% if is_sub_request %}
            <h4 class="xt-show-hide--parent">
                {{ nsName(ns, project.namespaces) }}
                <small class='xt-show'>[{{ msg('show')|lower }}]</small>
                <small class='xt-hide'>[{{ msg('hide')|lower }}]</small>
            </h4>
            {{ content }}
        {% else %}
            {% set downloadLink %}
                {{ layout.downloadLink('TopEditsResultNamespace', {'project': project.domain, 'username': user.usernameIdent, 'namespace': te.namespace, 'start': te.startDate, 'end': te.endDate}, ['wikitext'], 'UserApiTopEditsNamespace') }}
            {% endset %}
            {{ layout.content_block(nsName(ns, project.namespaces), content, downloadLink, ns, true, te.topEdits|length > 1) }}
        {% endif %}
    {% endfor %}
{% else %}
    <div class="alert alert-info">
        {{ msg('no-contribs') }}
    </div>
{% endif %}

{% if not is_sub_request %}
    </div></div>
{% endif %}
{% endblock %}
